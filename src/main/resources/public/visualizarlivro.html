<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Null Archive - Visualizar Obra</title>
    <link rel="stylesheet" href="Header.css">
    <link rel="stylesheet" href="estilo.css">
    <style>
        /* RESET E BASE */
        body { background-color: #0b1118; color: #e0e6ed; }

        .view-container {
            max-width: 1100px;
            margin: 60px auto;
            padding: 40px;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 50px;
            background: rgba(20, 33, 49, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(141, 162, 251, 0.1);
            border-radius: 8px;
            display: none; /* Ativado via JS */
        }

        /* ASIDE: CAPA E SPECS */
        .book-aside { display: flex; flex-direction: column; gap: 25px; }
        
        .full-cover { 
            width: 100%; 
            border-radius: 4px;
            border: 1px solid rgba(141, 162, 251, 0.3); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .tech-box { 
            border-top: 1px solid rgba(141, 162, 251, 0.1); 
            padding-top: 20px; 
            font-family: 'Segoe UI', sans-serif;
            font-size: 0.8rem; 
            color: rgba(224, 230, 237, 0.6); 
            line-height: 1.8;
        }

        .tech-label { 
            color: #8da2fb; /* Azul do tema */
            text-transform: uppercase; 
            font-size: 0.65rem; 
            font-weight: 800;
            letter-spacing: 2px;
            display: block; 
            margin-bottom: 10px;
        }

        .tech-box p span { color: #e0e6ed; font-weight: 500; }

        /* MAIN CONTENT */
        .book-main h1 { 
            font-size: 2.8rem; 
            color: #fff; 
            margin: 0; 
            letter-spacing: -1px; 
            text-transform: uppercase;
        }

        .author-sub { 
            color: #baa8f8; /* Lilás para o autor */
            font-size: 1.1rem; 
            margin-bottom: 25px; 
            display: block; 
            letter-spacing: 1px;
        }

        .description-text { 
            line-height: 1.8; 
            color: rgba(224, 230, 237, 0.8); 
            margin-bottom: 40px; 
            font-size: 1rem;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
        }

        /* TAGS */
        .tag-pill {
            background: rgba(141, 162, 251, 0.1);
            color: #8da2fb;
            border: 1px solid rgba(141, 162, 251, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-right: 8px;
        }

        /* BOTOES NAV-BTN STYLE */
        .action-zone { display: flex; gap: 20px; margin-top: 40px; }

        .nav-btn {
            background: rgba(141, 162, 251, 0.1);
            color: #8da2fb;
            border: 1px solid #8da2fb;
            padding: 12px 30px;
            font-weight: bold;
            letter-spacing: 2px;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 0.8rem;
            flex: 1;
            text-align: center;
        }

        .nav-btn:hover {
            background: #8da2fb;
            color: #0b1118;
            box-shadow: 0 0 20px rgba(141, 162, 251, 0.4);
        }

        .btn-secondary-outline {
            border-color: #baa8f8;
            color: #baa8f8;
            background: transparent;
        }

        .btn-secondary-outline:hover {
            background: #baa8f8;
            color: #0b1118;
            box-shadow: 0 0 20px rgba(186, 168, 248, 0.4);
        }

        /* PAINEL DE MODERAÇÃO REESTILIZADO */
.admin-panel { 
    margin-top: 50px; 
    padding: 30px; 
    background: linear-gradient(135deg, rgba(141, 162, 251, 0.05), rgba(186, 168, 248, 0.05));
    border: 1px solid rgba(141, 162, 251, 0.2);
    border-radius: 20px; /* Bordas bem arredondadas */
    backdrop-filter: blur(10px);
    display: none; 
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.admin-actions { 
    display: flex; 
    gap: 15px; 
    margin-top: 20px; 
}

/* Botões arredondados e estilizados */
.btn-mod {
    padding: 12px 25px;
    font-size: 0.75rem;
    letter-spacing: 1.5px;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 50px; /* Estilo pílula, nada quadrado */
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: transparent;
    flex: 1;
}

/* Aprovar: Azul Brilhante */
.btn-approve { 
    border: 1px solid #8da2fb; 
    color: #8da2fb; 
}
.btn-approve:hover { 
    background: #8da2fb; 
    color: #0b1118; 
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(141, 162, 251, 0.4);
}

/* Rejeitar: Roxo/Lilás (substituindo o vermelho feio) */
.btn-reject { 
    border: 1px solid #baa8f8; 
    color: #baa8f8; 
}
.btn-reject:hover { 
    background: #baa8f8; 
    color: #0b1118; 
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(186, 168, 248, 0.4);
}

/* Ajuste fino nos outros elementos para arredondar tudo */
.view-container, .full-cover, .description-text, .nav-btn {
    border-radius: 15px;
}
    </style>
</head>

<body>
<header id="main-header" class="main-header"></header>

<div class="view-container" id="book-content">
    <aside class="book-aside">
        <img id="book-cover" src="" class="full-cover" alt="Capa">
        
        <div class="tech-box">
            <span class="tech-label">Technical Metadata</span>
            <p>IDIOMA: <span id="info-lang"></span></p>
            <p>ANO: <span id="info-year"></span></p>
            <p>LICENÇA: <span id="info-license"></span></p>
        </div>

        <div class="tech-box">
            <span class="tech-label">System File Specs</span>
            <p>DATA-TYPE: <span id="info-kind"></span></p>
            <p>VOLUME: <span id="info-size"></span> MB</p>
            <p>INDEXED: <span id="info-date"></span></p>
            <p>SOURCE: <span id="info-user"></span></p>
        </div>
    </aside>

    <main class="book-main">
        <h1 id="book-title">Título</h1>
        <span id="book-author" class="author-sub">Autor</span>
        
        <div id="book-tags" style="margin-bottom: 30px;"></div>

        <div id="book-description" class="description-text"></div>

        <div class="tech-box" style="margin-bottom: 20px;">
            <span class="tech-label">Origin Link</span>
            <a id="book-source" href="#" target="_blank" style="color: #8da2fb; text-decoration: none; font-size: 0.8rem; opacity: 0.8;">N/A</a>
        </div>

        <div class="action-zone">
            <button id="btn-download" class="nav-btn btn-secondary-outline">⇣ DOWNLOAD_FILE</button>
            <button id="btn-view" class="nav-btn">◈ ONLINE_READER</button>
        </div>

        <div id="admin-decision" class="admin-panel">
            <span class="tech-label">Terminal de Verificação</span>
            <p style="font-size: 0.85rem; color: rgba(141, 162, 251, 0.7); margin-bottom: 5px;">
                Status: <span style="color: #baa8f8; font-weight: bold;">AGUARDANDO VALIDAÇÃO</span>
            </p>
            <div class="admin-actions">
                <button class="btn-mod btn-approve" id="btn-approve">Autorizar Registro</button>
                <button class="btn-mod btn-reject" id="btn-reject">Expurgar Dados</button>
            </div>
        </div>
    </main>
</div>

<script src="Header.js"></script>
<script>
let book;

async function loadBookDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');

    if (!bookId) {
        document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:100px;'>ACCESS_DENIED: ID_NOT_FOUND</h1>";
        return;
    }

    try {
        const res = await fetch(`http://127.0.0.1:8081/book/info?id=${bookId}`, { credentials: "include" });
        book = await res.json();
        
        // Populando dados
        document.getElementById('book-title').innerText = book.title;
        document.getElementById('book-author').innerText = book.author_name;
        document.getElementById('info-lang').innerText = book.language_code;
        document.getElementById('info-year').innerText = book.published_year + (book.is_bc ? " a.C" : " d.C");
        document.getElementById('info-license').innerText = book.license;
        document.getElementById('info-kind').innerText = book.file_kind || 'UNKNOWN';
        document.getElementById('info-user').innerText = `@${book.username || 'archive_bot'}`;
        document.getElementById('info-size').innerText = (book.size_bytes / (1024 * 1024)).toFixed(2);
        document.getElementById('info-date').innerText = new Date(book.created_at).toLocaleDateString();
        document.getElementById('book-description').innerText = book.description || 'No record log description.';
        document.getElementById('book-source').innerText = book.source_url;
        
        // Cover
        document.getElementById('book-cover').src = book.storage_path_image 
            ? `http://127.0.0.1:8081/user/image/${book.storage_path_image}` 
            : 'placeholder.png';

        // Tags
        const tagsContainer = document.getElementById('book-tags');
        let tagsArray = typeof book.tags === 'string' ? book.tags.split(',') : (book.tags || []);
        tagsContainer.innerHTML = tagsArray.map(t => `<span class="tag-pill">${t.trim()}</span>`).join('');

        // Ações
        document.getElementById('btn-download').onclick = () => baixarArquivo(book.storage_path_file, book.original_filename);
        document.getElementById('btn-view').onclick = () => lerArquivo(book.storage_path_file);

        // Admin Check
        if (urlParams.has('admin')) {
            const adminRes = await fetch('http://127.0.0.1:8081/editor/data', { credentials: "include" });
            const account = await adminRes.json();
            if (account.role === "ADMIN") {
                document.getElementById('admin-decision').style.display = 'block';
                document.getElementById('btn-approve').onclick = () => moderarLivro(bookId, 'approve');
                document.getElementById('btn-reject').onclick = () => moderarLivro(bookId, 'desapprove');
            }
        }

        document.getElementById('book-content').style.display = 'grid';

    } catch (err) {
        console.error("Critical System Error:", err);
    }
}

function baixarArquivo(storage_path_file, original_filename) {
    const url = `http://localhost:8081/book/file/${storage_path_file}?action=download&name=${encodeURIComponent(original_filename)}`;
    const a = document.createElement('a');
    a.href = url;
    a.download = original_filename;
    a.click();
}

async function lerArquivo(storage_path_file) {
    await fetch('http://127.0.0.1:8081/user/reading', { 
        method: 'POST', credentials: "include", 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ book_id: book.id })
    });
    window.open(`http://localhost:8081/book/file/${storage_path_file}?action=view`, '_blank');
}

async function moderarLivro(id, acao) {
    if (!confirm(`Deseja executar a ação: ${acao}?`)) return;
    const response = await fetch('http://127.0.0.1:8081/admin/approve', {
        method: 'POST', credentials: "include",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, action: acao })
    });
    if (response.ok) { window.location.href = "gerenciarLivros.html"; }
}

loadBookDetails();
</script>
</body>
</html>