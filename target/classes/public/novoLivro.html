<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Novo Livro</title>
  <link rel="stylesheet" href="estilo.css">
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
    h1 { margin-bottom: 8px; }
    .muted { color: #666; font-size: 0.95rem; }
    form { margin-top: 18px; display: grid; gap: 14px; }
    .row { display: grid; gap: 8px; }
    label { font-weight: 600; }
    input, textarea, select { padding: 10px; font-size: 1rem; }
    textarea { min-height: 120px; resize: vertical; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .actions { display: flex; gap: 12px; align-items: center; }
    button { padding: 10px 14px; font-size: 1rem; cursor: pointer; }
    .danger { background: #fff; border: 1px solid #c00; color: #c00; }
    .ok { background: #0a7; border: 1px solid #0a7; color: #fff; }
    .card { border: 1px solid #ddd; padding: 14px; border-radius: 8px; }
    .hint { font-size: 0.9rem; color: #444; }
    .status { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
  <link rel="stylesheet" href="novoLivro.css">
</head>
<body>
  <a href="Home.html">voltar</a>
  <h1>Adicionar livro</h1>
  <p class="muted">Envie metadados e o arquivo (PDF/EPUB/MOBI/TXT/OUTRO).</p>

  <div class="card">
    <form id="bookForm">

      <div class="row">
        <label for="title">Título *</label>
        <input id="title" name="title" type="text" maxlength="255" required />
      </div>

      <div class="grid2">
        <div class="row">
          <label for="author_name">Autor</label>
          <input id="author_name" name="author_name" type="text" maxlength="255" />
        </div>

        <div class="row">
          <label for="published_year">Ano (ex: 2008)</label>
          <input id="published_year" name="published_year" type="number" min="0" max="3000" />
        </div>
        <div class="row">
          <select id="era" name="era" style="height: 100%; min-height: 38px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="DC">d.C.</option>
            <option value="AC">a.C.</option>
          </select>
        </div>

        
      </div>

      <div class="row">
        <label for="description">Descrição</label>
        <textarea id="description" name="description"></textarea>
      </div>

      <div class="grid3">
        <div class="row">
          <label for="language_code">Idioma (ex: pt-BR, en)</label>
          <input id="language_code" name="language_code" type="text" maxlength="5" placeholder="pt-BR" />
          <div class="hint">No seu schema é CHAR(5). Exemplos: <code>pt-BR</code>, <code>en</code>.</div>
        </div>

        <div class="row">
          <label for="license">Licença *</label>
          <select id="license" name="license" required>
            <option value="UNKNOWN">UNKNOWN</option>
            <option value="PUBLIC_DOMAIN">PUBLIC_DOMAIN</option>
            <option value="CC0">CC0</option>
            <option value="CC_BY">CC_BY</option>
            <option value="CC_BY_SA">CC_BY_SA</option>
          </select>
        </div>

        <div class="row">
          <label for="source_url">Fonte (URL)</label>
          <input id="source_url" name="source_url" type="url" maxlength="2048" placeholder="https://..." />
        </div>
      </div>

      <div class="card">
        <h3 style="margin: 0 0 10px;">Arquivo do livro *</h3>

        <div class="grid2">
          <div class="row">
            <label for="file_kind">Tipo *</label>
            <select id="file_kind" name="file_kind" required>
              <option value="PDF">PDF</option>
              <option value="EPUB">EPUB</option>
              <option value="MOBI">MOBI</option>
              <option value="TXT">TXT</option>
              <option value="OTHER">OTHER</option>
            </select>
          </div>

          <div class="row">
            <label for="book_file">Arquivo *</label>
            <input id="book_file" name="book_file" type="file" required />
            <label for="image_book">Imagem do Arquivo *</label>
            <input id="image_book" name="image_book" type="file" required />
            <div class="hint">O backend deve salvar o arquivo no disco e registrar em <code>book_files</code>.</div>
          </div>
        </div>
      </div>



      <div class="actions">
        <button class="ok" type="submit">Enviar</button>
        <button class="danger" type="button" id="resetBtn">Limpar</button>
      </div>

      <div class="card">
        <div class="muted">Status</div>
        <div id="status" class="status"></div>
      </div>

    </form>
  </div>
  <label>Selecione entre 1 e 3 tags:</label>
  <div id="container-tags" class="tag-wrapper">
      </div>

  <input type="hidden" name="tags_selecionadas" id="tags-input">


<script>
  
  const form = document.getElementById("bookForm");
  const statusEl = document.getElementById("status");
  const resetBtn = document.getElementById("resetBtn");
  const container = document.getElementById('container-tags');
  let contaTags =0;
  let tagsSelecionadas = []; // Array para guardar os IDs

  async function loadTags() {
    const res = await fetch("http://127.0.0.1:8081/editor/tags", {
      credentials: "include"
    });

    if (!res.ok) {
      return;
    }


    const data = await res.json();

    // Limpa o container antes de carregar (caso a função seja chamada mais de uma vez)
      //container.innerHTML = '';

      // --- O PULO DO GATO ESTÁ AQUI ---
      // Percorremos cada item (tag) dentro do array 'data'
      data.forEach(tag => {
          // 2. Cria o botão dinamicamente para CADA tag
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.innerText = tag.nome;
          btn.classList.add('btn-tag');

          // 3. Lógica do Clique
          btn.addEventListener('click', () => {
              toggleTag(btn, tag.id);
          });

          // Adiciona o botão criado ao container na tela
          container.appendChild(btn);
      });


  }
  loadTags()

function toggleTag(elemento, id) {
    if (tagsSelecionadas.includes(id)) {
        // Se já está no array, remove (desmarcar)
        tagsSelecionadas = tagsSelecionadas.filter(item => item !== id);
        elemento.classList.remove('selecionado');
        contaTags--;
    } else {
        if(contaTags<3){
          // Se não está, adiciona (marcar)
          tagsSelecionadas.push(id);
          elemento.classList.add('selecionado');
          contaTags++;
        }
    }

}


  resetBtn.addEventListener("click", () => {
    form.reset();
    statusEl.textContent = "";
  });

  function setStatus(msg) {
    statusEl.textContent = msg;
  }



  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById("book_file");
    const fileBook = fileInput.files[0];
    if (!fileBook) {
      setStatus("Selecione um arquivo.");
      return;
    }
    const imageInput = document.getElementById("image_book");
    const fileImage = imageInput.files[0];
    if (!fileImage) {
      setStatus("Selecione uma imagem.");
      return;
    }
    
    era = false;
    if(document.getElementById('era').value=="AC") era=true;
    else era=false;
    const payload = {
      title: document.getElementById("title").value,
      author_name: document.getElementById("author_name").value || null,
      description: document.getElementById("description").value || null,
      language_code: document.getElementById("language_code").value || null,
      published_year: document.getElementById("published_year").value ? Number(document.getElementById("published_year").value) : null,
      license: document.getElementById("license").value,
      source_url: document.getElementById("source_url").value || null,
      file_kind: document.getElementById("file_kind").value,
      era: era,
      tags: tagsSelecionadas
    };

    const fd = new FormData();
    fd.append("meta", new Blob([JSON.stringify(payload)], { type: "application/json" }));
    fd.append("file", fileBook);
    fd.append("image", fileImage);

    setStatus("Enviando...");

    try {
      const res = await fetch("http://127.0.0.1:8081/editor/book", {
        method: "POST",
        credentials: "include",
        body: fd
      });

      const text = await res.text();

      if (!res.ok) {
        setStatus("Erro (" + res.status + "):\n" + text);
        return;
      }

      setStatus("OK (" + res.status + "):\n" + text);
      // opcional: redirecionar ou limpar
      // window.location.href = "Home.html";
    } catch (err) {
      setStatus("Falha de rede:\n" + String(err));
    }
  });
</script>

</body>
</html>
